ZKUploader.define(["jquery","backbone"],function(o,e){"use strict";var s=!1,n=12e3,a={init:function(e){function a(){for(var e=o("a[role=treeitem]"),s=0;s<e.length;s++)if("USB"==e[s].text)return!0;return!1}function t(o){a()&&o.data.toolbar.push({name:"Backup",label:"一键备份",priority:0,icon:"onekeybackup",action:function(){e.request("dialog:info",{name:"ConfirmOnekeybackupDialog",title:"提示",msg:"一键备份：把图片和文件全部同步到移动存储设备上？",buttons:["ok","cancel"]})}})}e.on("app:ready",function(t){function i(){o.ajax({url:"core/connector/php/connector.php?command=Connectstatus",type:"GET",success:function(o){if("ok"==o.status){if(a())return void(s&&console.log("连接状态: 已连接"));e.request("dialog:info",{name:"CheckConnectStatusDialog",title:"提示",msg:"发现移动存储设备已接入",buttons:["ok"]})}else a()&&(s&&console.log("连接状态: 连接断开"),e.request("dialog:info",{name:"CheckConnectStatusDialog",title:"提示",msg:"移动存储设备已断开",buttons:["ok"]}))},error:function(){s&&console.log("http 请求错误，请检测网络/网管")}})}setInterval(i.bind(this),n),e.on("dialog:CheckConnectStatusDialog:ok",function(o){s&&console.log("正在刷新..."),window.location.reload(),e.request("dialog:destroy")})}),e.on("toolbar:reset:Main:resources",function(o){s&&console.log("toolbar:reset:Main:resources"),t(o)},this,null,1e3),e.on("toolbar:reset:Main:folder",function(o){s&&console.log("toolbar:reset:Main:folder"),t(o)},this,null,1e3),e.on("toolbar:reset:Main:file",function(o){s&&console.log("toolbar:reset:Main:file"),t(o)},this,null,1e3),e.on("toolbar:reset:Main:files",function(o){s&&console.log("toolbar:reset:Main:files"),t(o)},this,null,1e3),e.on("dialog:ConfirmOnekeybackupDialog:ok",function(n){s&&console.log("正在备份..."),e.request("dialog:destroy"),e.request("loader:show",{text:"获取同步数据中..."}),o.ajax({url:"core/connector/php/connector.php?command=Getallfiles",type:"GET",success:function(o){e.fire("Backup:getallfiles:success",o),e.request("loader:hide")},error:function(){}})}),e.on("Backup:getallfiles:success",function(o){s&&console.log("获取到的列表 "+o.data);var n=o.data||[];e.request("dialog",{name:"BackupfileDialog",title:"提示",template:'<div data-role="navbar" class="ckf-upload-dropzone ui-body-a ui-navbar" tabindex="20" role="navigation" style="border: 0;"><div class="ui-content"><div class="ckf-upload-dropzone-grid"><div class="ckf-upload-dropzone-grid-a"><p id="ckf-label-301" class="ckf-upload-status">正在上传:<span class="backup-file">foo.jpg</span></p><p class="ckf-upload-progress-text" style=""><span class="ckf-upload-progress-text-files">已上传文件：<span class="backup-finish">11</span>/<span class="backup-total">20</span></span></p></div></div><div id="ckf-upload-progress"><div class="ckf-progress"><div class="ckf-progress-message ckf-hidden"></div><div class="ckf-progress-wrap ckf-progress-ok" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><div class="ckf-progress-bar backup-progress" style="width: 0%;"></div></div></div></div></div></div>',buttons:["ok","cancel"]}),e.fire("Backup:process",{cpfiles:n,index:0})}),e.on("Backup:process",function(n){var a=n.data.cpfiles,t=n.data.index;o.ajax({url:"core/connector/php/connector.php?command=Backupfile&cpfile="+encodeURIComponent(a[t]),type:"GET",success:function(n){s&&console.log(n),"ok"==n.status?(o(".backup-file").text(a[t]),o(".backup-finish").text(t+1),o(".backup-total").text(a.length),o(".ckf-progress-bar")[0].style.width=(t+1)/a.length*100+"%",t+1<a.length?e.fire("Backup:process",{cpfiles:a,index:t+1}):e.fire("Backup:process:finish",{cpfiles:a})):e.request("dialog:info",{name:"NetworkErrorDialog",title:"提示",msg:n.msg,buttons:["okClose"]})},error:function(){e.request("dialog:close:BackupfileDialog"),e.request("dialog:info",{name:"NetworkErrorDialog",title:"提示",msg:"网络繁忙，请稍后再试!",buttons:["okClose"]})}})}),e.on("Backup:process:finish",function(o){e.request("dialog:info",{name:"BackupFinishDialog",title:"提示",msg:"备份完毕！",buttons:["okClose"]})})}};return a});